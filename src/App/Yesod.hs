{-# LANGUAGE QuasiQuotes #-}
{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE ViewPatterns #-}

module App.Yesod
  ( main,
    -- Suppress warning for unused top-level bindings generated by TH
    resourcesApp,
    Widget,
  )
where

import App.Config (Config (configPaymentMaxRetries), configInit)
import App.Text (tshow)
import Data.Text (Text)
import Network.Wai.Handler.Warp (run)
import Yesod.Core (Yesod, getsYesod, mkYesod, parseRoutes, renderRoute, toWaiAppPlain)

data App = App
  { appConfig :: Config,
    appLogger :: ()
  }

appInit :: IO App
appInit = do
  config <- configInit
  let app =
        App
          { appConfig = config,
            appLogger = ()
          }
  pure app

mkYesod
  "App"
  [parseRoutes|
  /cart/#Text/purchase CartPurchaseR POST
|]

instance Yesod App

postCartPurchaseR :: Text -> Handler Text
postCartPurchaseR cartId = do
  paymentMaxRetries <- getsYesod (configPaymentMaxRetries . appConfig)
  let response =
        mconcat
          [ "cartId: ",
            cartId,
            "\n",
            "paymentMaxRetries: ",
            tshow paymentMaxRetries,
            "\n"
          ]
  pure response

main :: IO ()
main = do
  app <- appInit
  waiApp <- toWaiAppPlain app
  let port = 3000
  run port waiApp
